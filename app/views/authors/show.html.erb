<% content_for :title, "#{@author.name} - BookStore" %>

<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
      <li class="breadcrumb-item"><%= link_to "Authors", authors_path %></li>
      <li class="breadcrumb-item active" aria-current="page"><%= @author.name %></li>
    </ol>
  </nav>

  <!-- Author Profile -->
  <div class="row mb-5">
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-user-circle fa-5x text-muted"></i>
          </div>
          <h3><%= @author.name %></h3>
          <p class="text-muted mb-3">
            <i class="fas fa-flag me-2"></i><%= @author.nationality %>
          </p>
          <p class="text-muted mb-3">
            <i class="fas fa-birthday-cake me-2"></i>Born <%= @author.birth_date.strftime("%B %d, %Y") %>
          </p>
          <p class="text-muted">
            <i class="fas fa-book me-2"></i><%= pluralize(@books.total_count, 'book') %> in our collection
          </p>
        </div>
      </div>
    </div>
    
    <div class="col-lg-8">
      <h1><%= @author.name %></h1>
      
      <div class="mb-4">
        <h3>Biography</h3>
        <p class="text-justify"><%= @author.biography %></p>
      </div>

      <% if @books.any? %>
        <!-- Author Statistics -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-primary"><%= @books.total_count %></h4>
              <p class="mb-0">Books</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-success"><%= @books.joins(:category).distinct.count('categories.id') %></h4>
              <p class="mb-0">Categories</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-warning">$<%= @books.average(:price).round(2) %></h4>
              <p class="mb-0">Avg. Price</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-info"><%= @books.joins(:reviews).count %></h4>
              <p class="mb-0">Reviews</p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Author's Books -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h2>Books by <%= @author.name %></h2>
      <%= link_to "All Authors", authors_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <% if @books.any? %>
    <div class="row">
      <% @books.each do |book| %>
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card book-card h-100">
            <div class="book-cover">
              <h6><%= truncate(book.title, length: 40) %></h6>
            </div>
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">
                <%= link_to book.title, book_path(book), class: "text-decoration-none" %>
              </h6>
              <p class="text-muted mb-2">
                <small>
                  <%= link_to book.category.name, category_path(book.category), class: "text-decoration-none" %>
                </small>
              </p>
              <p class="card-text flex-grow-1">
                <%= truncate(book.description, length: 120) %>
              </p>
              
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="h6 text-success mb-0">$<%= book.price %></span>
                  <small class="text-muted"><%= book.pages %> pages</small>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">
                    Published: <%= book.publication_date.strftime("%Y") %>
                  </small>
                  <% if book.reviews.any? %>
                    <small class="text-muted">
                      <span class="rating">
                        <% avg_rating = book.reviews.average(:rating).round(1) %>
                        <% avg_rating.floor.times do %><i class="fas fa-star"></i><% end %>
                        <% if avg_rating % 1 != 0 %><i class="fas fa-star-half-alt"></i><% end %>
                        <% (5 - avg_rating.ceil).times do %><i class="far fa-star"></i><% end %>
                      </span>
                      (<%= book.reviews.count %>)
                    </small>
                  <% end %>
                </div>
                
                <div class="d-grid">
                  <%= link_to "View Details", book_path(book), class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @books %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="fas fa-book fa-4x text-muted mb-3"></i>
      <h3>No books available</h3>
      <p class="text-muted">This author doesn't have any books in our collection yet.</p>
      <%= link_to "Browse All Books", books_path, class: "btn btn-primary" %>
    </div>
  <% end %>

  <!-- Categories this author writes in -->
  <% if @books.any? %>
    <div class="mt-5">
      <h3>Categories</h3>
      <p class="text-muted mb-3"><%= @author.name %> writes in the following categories:</p>
      
      <div class="d-flex flex-wrap gap-2">
        <% @books.joins(:category).distinct.pluck('categories.name', 'categories.id').each do |cat_name, cat_id| %>
          <%= link_to cat_name, category_path(cat_id), class: "btn btn-outline-primary btn-sm" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
