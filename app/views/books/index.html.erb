<% content_for :title, "All Books - BookStore" %>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
      <% if @category %>
        Books in <%= @category.name %>
      <% elsif @author %>
        Books by <%= @author.name %>
      <% else %>
        All Books
      <% end %>
    </h1>
    <%= link_to "Search Books", search_path, class: "btn btn-outline-primary" %>
  </div>

  <% if @category %>
    <div class="alert alert-info">
      <strong><%= @category.name %>:</strong> <%= @category.description %>
    </div>
  <% end %>

  <% if @author %>
    <div class="alert alert-info">
      <strong>About <%= @author.name %>:</strong> <%= truncate(@author.biography, length: 200) %>
    </div>
  <% end %>

  <!-- Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Filter by Category</h5>
      <div class="d-flex flex-wrap gap-2">
        <%= link_to "All Books", books_path, 
            class: "btn #{'btn-primary' if params[:category_id].blank?} #{'btn-outline-primary' unless params[:category_id].blank?} btn-sm" %>
        <% @categories.each do |category| %>
          <%= link_to category.name, books_path(category_id: category.id), 
              class: "btn #{'btn-primary' if params[:category_id] == category.id.to_s} #{'btn-outline-primary' unless params[:category_id] == category.id.to_s} btn-sm" %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <% if @books.any? %>
      <% @books.each do |book| %>
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card book-card h-100">
            <div class="book-cover">
              <h6><%= truncate(book.title, length: 40) %></h6>
            </div>
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">
                <%= link_to book.title, book_path(book), class: "text-decoration-none" %>
              </h6>
              <p class="text-muted mb-1">
                by <%= link_to book.author.name, author_path(book.author), class: "text-decoration-none" %>
              </p>
              <p class="text-muted mb-2">
                <small>
                  <%= link_to book.category.name, category_path(book.category), class: "text-decoration-none" %>
                </small>
              </p>
              <p class="card-text flex-grow-1">
                <%= truncate(book.description, length: 120) %>
              </p>
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="h6 text-success mb-0">$<%= book.price %></span>
                  <small class="text-muted"><%= book.pages %> pages</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <% if book.reviews.any? %>
                      <span class="rating">
                        <% avg_rating = (book.reviews.average(:rating) || 0).round(1) %>
                        <% avg_rating.floor.times do %><i class="fas fa-star"></i><% end %>
                        <% if avg_rating % 1 != 0 %><i class="fas fa-star-half-alt"></i><% end %>
                        <% (5 - avg_rating.ceil).times do %><i class="far fa-star"></i><% end %>
                      </span>
                      (<%= book.reviews.count %>)
                    <% else %>
                      No reviews yet
                    <% end %>
                  </small>
                  <%= link_to "View Details", book_path(book), class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="col-12">
        <div class="text-center py-5">
          <i class="fas fa-book fa-4x text-muted mb-3"></i>
          <h3>No books found</h3>
          <p class="text-muted">Try adjusting your filters or <%= link_to "browse all books", books_path %>.</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-4">
    <%= paginate @books %>
  </div>
</div>
