<% content_for :title, "#{@book.title} - BookStore" %>

<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
      <li class="breadcrumb-item"><%= link_to "Books", books_path %></li>
      <li class="breadcrumb-item"><%= link_to @book.category.name, category_path(@book.category) %></li>
      <li class="breadcrumb-item active" aria-current="page"><%= truncate(@book.title, length: 30) %></li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="book-cover" style="min-height: 300px;">
          <h4 class="text-center"><%= @book.title %></h4>
        </div>
        <div class="card-body text-center">
          <h5 class="text-success mb-3">$<%= @book.price %></h5>
          <p><strong>ISBN:</strong> <%= @book.isbn %></p>
          <p><strong>Pages:</strong> <%= @book.pages %></p>
          <p><strong>Published:</strong> <%= @book.publication_date.strftime("%B %Y") %></p>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <h1><%= @book.title %></h1>
      
      <p class="lead mb-3">
        by <%= link_to @book.author.name, author_path(@book.author), class: "text-decoration-none fw-bold" %>
      </p>
      
      <p class="mb-3">
        <span class="badge bg-primary"><%= link_to @book.category.name, category_path(@book.category), class: "text-white text-decoration-none" %></span>
      </p>

      <% if @book.reviews.any? %>
        <div class="mb-3">
          <div class="d-flex align-items-center">
            <div class="rating me-2">
              <% avg_rating = (@book.reviews.average(:rating) || 0).round(1) %>
              <% avg_rating.floor.times do %><i class="fas fa-star"></i><% end %>
              <% if avg_rating % 1 != 0 %><i class="fas fa-star-half-alt"></i><% end %>
              <% (5 - avg_rating.ceil).times do %><i class="far fa-star"></i><% end %>
            </div>
            <span><%= avg_rating %> out of 5 (<%= pluralize(@book.reviews.count, 'review') %>)</span>
          </div>
        </div>
      <% end %>

      <h3>Description</h3>
      <p class="text-justify"><%= @book.description %></p>

      <div class="row mt-4">
        <div class="col-md-6">
          <h4>Author Information</h4>
          <p><strong><%= @book.author.name %></strong></p>
          <p><%= truncate(@book.author.biography, length: 200) %></p>
          <p><strong>Nationality:</strong> <%= @book.author.nationality %></p>
          <%= link_to "View all books by #{@book.author.name}", author_path(@book.author), class: "btn btn-outline-primary btn-sm" %>
        </div>
        <div class="col-md-6">
          <h4>Category</h4>
          <p><strong><%= @book.category.name %></strong></p>
          <p><%= @book.category.description %></p>
          <%= link_to "Browse #{@book.category.name}", category_path(@book.category), class: "btn btn-outline-primary btn-sm" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="row mt-5">
    <div class="col-12">
      <h3>Reviews</h3>
      
      <!-- Add Review Form -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Write a Review</h5>
        </div>
        <div class="card-body">
          <%= form_with(model: [@book, @new_review], local: true) do |form| %>
            <% if @new_review.errors.any? %>
              <div class="alert alert-danger">
                <h6><%= pluralize(@new_review.errors.count, "error") %> prohibited this review from being saved:</h6>
                <ul class="mb-0">
                  <% @new_review.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="row">
              <div class="col-md-6 mb-3">
                <%= form.label :reviewer_name, class: "form-label" %>
                <%= form.text_field :reviewer_name, class: "form-control" %>
              </div>
              <div class="col-md-6 mb-3">
                <%= form.label :rating, class: "form-label" %>
                <%= form.select :rating, options_for_select([[1,1],[2,2],[3,3],[4,4],[5,5]]), 
                    { prompt: "Select rating" }, { class: "form-select" } %>
              </div>
            </div>
            <div class="mb-3">
              <%= form.label :content, "Review", class: "form-label" %>
              <%= form.text_area :content, rows: 4, class: "form-control" %>
            </div>
            <%= form.submit "Submit Review", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>

      <!-- Display Reviews -->
      <% if @reviews.any? %>
        <% @reviews.each do |review| %>
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title mb-0"><%= review.reviewer_name %></h6>
                <div class="rating">
                  <% review.rating.times do %><i class="fas fa-star"></i><% end %>
                  <% (5 - review.rating).times do %><i class="far fa-star"></i><% end %>
                </div>
              </div>
              <p class="text-muted small mb-2">Reviewed on <%= review.created_at.strftime("%B %d, %Y") %></p>
              <p class="card-text"><%= review.content %></p>
            </div>
          </div>
        <% end %>

        <!-- Reviews Pagination -->
        <div class="d-flex justify-content-center">
          <%= paginate @reviews %>
        </div>
      <% else %>
        <div class="text-center py-4">
          <i class="fas fa-comment fa-3x text-muted mb-3"></i>
          <h5>No reviews yet</h5>
          <p class="text-muted">Be the first to review this book!</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
