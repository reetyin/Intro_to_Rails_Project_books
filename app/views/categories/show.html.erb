<% content_for :title, "#{@category.name} Books - BookStore" %>

<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
      <li class="breadcrumb-item"><%= link_to "Categories", categories_path %></li>
      <li class="breadcrumb-item active" aria-current="page"><%= @category.name %></li>
    </ol>
  </nav>

  <div class="mb-4">
    <h1><%= @category.name %></h1>
    <p class="lead"><%= @category.description %></p>
    
    <div class="d-flex justify-content-between align-items-center">
      <p class="mb-0">
        <strong><%= pluralize(@books.total_count, 'book') %></strong> in this category
      </p>
      <div>
        <%= link_to "All Categories", categories_path, class: "btn btn-outline-secondary me-2" %>
        <%= link_to "All Books", books_path, class: "btn btn-outline-primary" %>
      </div>
    </div>
  </div>

  <% if @books.any? %>
    <div class="row">
      <% @books.each do |book| %>
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card book-card h-100">
            <div class="book-cover">
              <h6><%= truncate(book.title, length: 40) %></h6>
            </div>
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">
                <%= link_to book.title, book_path(book), class: "text-decoration-none" %>
              </h6>
              <p class="text-muted mb-2">
                by <%= link_to book.author.name, author_path(book.author), class: "text-decoration-none" %>
              </p>
              <p class="card-text flex-grow-1">
                <%= truncate(book.description, length: 120) %>
              </p>
              
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="h6 text-success mb-0">$<%= book.price %></span>
                  <small class="text-muted"><%= book.pages %> pages</small>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">
                    Published: <%= book.publication_date.strftime("%Y") %>
                  </small>
                  <% if book.reviews.any? %>
                    <small class="text-muted">
                      <span class="rating">
                        <% avg_rating = (book.reviews.average(:rating) || 0).round(1) %>
                        <% avg_rating.floor.times do %><i class="fas fa-star"></i><% end %>
                        <% if avg_rating % 1 != 0 %><i class="fas fa-star-half-alt"></i><% end %>
                        <% (5 - avg_rating.ceil).times do %><i class="far fa-star"></i><% end %>
                      </span>
                      (<%= book.reviews.count %>)
                    </small>
                  <% end %>
                </div>
                
                <div class="d-grid">
                  <%= link_to "View Details", book_path(book), class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @books %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="fas fa-book fa-4x text-muted mb-3"></i>
      <h3>No books in this category yet</h3>
      <p class="text-muted">Check back later for new additions to this category.</p>
      <%= link_to "Browse All Books", books_path, class: "btn btn-primary" %>
    </div>
  <% end %>

  <!-- Category Statistics -->
  <% if @books.any? %>
    <div class="mt-5">
      <div class="card bg-light">
        <div class="card-body">
          <h5 class="card-title">Category Statistics</h5>
          <div class="row text-center">
            <div class="col-md-3">
              <h4 class="text-primary"><%= @books.total_count %></h4>
              <p class="mb-0">Total Books</p>
            </div>
            <div class="col-md-3">
              <h4 class="text-success"><%= @books.joins(:author).distinct.count('authors.id') %></h4>
              <p class="mb-0">Authors</p>
            </div>
            <div class="col-md-3">
              <h4 class="text-warning">$<%= (@books.average(:price) || 0).round(2) %></h4>
              <p class="mb-0">Avg. Price</p>
            </div>
            <div class="col-md-3">
              <h4 class="text-info"><%= @books.joins(:reviews).count %></h4>
              <p class="mb-0">Total Reviews</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
